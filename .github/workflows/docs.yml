name: HyprJSON Build & Docs
on: [push]

permissions:
  contents: write

jobs:
  build-and-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Parse Docs and Todos
        shell: python
        run: |
          import re, os
          from datetime import datetime
          
          docs = {}
          todos = []
          
          # Regex for @docs (block) and // TODO: (line)
          doc_pattern = re.compile(r"/\*\*@docs\s+([\w\d]+)(.*?)\*\*/", re.DOTALL)
          # Grabs everything after // TODO: until the end of the line
          todo_pattern = re.compile(r"//\s*TODO\s*:\s*(.*)", re.IGNORECASE)

          for root, dirs, files in os.walk('.'):
              if '.git' in root or 'node_modules' in root or 'extra' in root: continue 
              for file in files:
                  if file.endswith('.js') and not file.endswith('.min.js'):
                      file_path = os.path.join(root, file)
                      with open(file_path, 'r', encoding='utf-8') as f:
                          lines = f.readlines()
                          content = "".join(lines)
                          
                          # Extract Docs
                          doc_matches = doc_pattern.findall(content)
                          for category, text in doc_matches:
                              category = category.strip()
                              if category not in docs: docs[category] = []
                              clean_lines = [l.strip().lstrip('*').strip() for l in text.strip().split('\n')]
                              docs[category].append({"path": file_path, "body": "\n".join(filter(None, clean_lines))})
                          
                          # Extract Todos line by line
                          for line in lines:
                              todo_match = todo_pattern.search(line)
                              if todo_match:
                                  todos.append(f"- [ ] {todo_match.group(1).strip()} (in `{file_path}`)")

          os.makedirs('extra', exist_ok=True)

          # Write docs.md
          with open('extra/docs.md', 'w', encoding='utf-8') as f:
              f.write("# âš¡ HyprJSON API\n\n")
              f.write(f"*Last Sync: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}*\n\n")
              if not docs: f.write("âš ï¸ No docs found.")
              else:
                  f.write("## ðŸ“Œ Navigation\n")
                  for cat in sorted(docs.keys()): f.write(f"- [{cat}](#{cat.lower()})\n")
                  f.write("\n---\n")
                  for cat in sorted(docs.keys()):
                      f.write(f"## {cat}\n")
                      for entry in docs[cat]:
                          f.write(f"**Source:** `{entry['path']}`\n\n{entry['body']}\n\n---\n")

          # Write todo.md
          with open('extra/todo.md', 'w', encoding='utf-8') as f:
              f.write("# ðŸ“… HyprJSON To-Do List\n\n")
              if not todos: f.write("âœ… No tasks found. Stay chill.")
              else:
                  for item in todos: f.write(f"{item}\n")

      - name: Compile and Minify
        run: |
          if [ -f "core/init.js" ]; then 
            cat core/init.js > bundle.js
            echo "" >> bundle.js
          else 
            touch bundle.js
          fi
          
          find . -name "*.js" ! -path "./core/init.js" ! -name "bundle.js" ! -name "*.min.js" ! -path "./extra/*" | while read file; do
            cat "$file" >> bundle.js
            echo "" >> bundle.js
          done
          
          npx -y terser bundle.js --compress --mangle -o hyprjson.min.js
          rm bundle.js

      - name: Commit and Push
        run: |
          git config user.name "HyprBot"
          git config user.email "bot@hyprjson.dev"
          rm -f DOCS.md
          git add extra/docs.md extra/todo.md hyprjson.min.js
          git commit -m "build: sync docs and todos to /extra" || exit 0
          git push
